class e{constructor(e,t){this.parent=e,this.list=t}get length(){return this.list.length}each(e,t){this.list.forEach((s=>{e.bind(t)(new n(s))}))}remove(e){try{this.list[e].remove()}catch(t){throw`Cannot remove element in list by index :${e}`}}get(e){try{return new n(this.list[e])}catch(t){throw`Cannot get element in list by index :${e}`}}}function t(){return`_${(Math.floor(99999*Math.random())*Date.now()).toString(16)}`}class n{constructor(e){e instanceof HTMLElement?(e.turtle=e.turtle??{},e.turtle.key||(e.turtle.key=t())):e=e.HTMLElement,this.HTMLElement=e}get parent(){return new n(this.HTMLElement.parentElement)}get firstChild(){return new n(this.HTMLElement.firstElementChild)}get lastChild(){return new n(this.HTMLElement.lastElementChild)}get previousSibling(){return new n(this.HTMLElement.previousElementSibling)}get nextSibling(){return new n(this.HTMLElement.previousElementSibling)}get id(){return this.HTMLElement.id}set id(e){this.HTMLElement.id=e}get classList(){return this.HTMLElement.classList}set HTML(e){this.HTMLElement.innerHTML=e}get HTML(){return this.HTMLElement.innerHTML}set text(e){this.HTMLElement.textContent=e}get text(){return this.HTMLElement.textContent}set val(e){this.HTMLElement.value=e}get val(){return this.HTMLElement.value}set checked(e){this.HTMLElement.checked=e}get checked(){return this.HTMLElement.checked}set disabled(e){this.HTMLElement.disabled=e}get disabled(){return this.HTMLElement.disabled}get attrs(){return this.HTMLElement.attibutes}get styles(){return this.HTMLElement.style}get childNodes(){return this.HTMLElement.childNodes}computedStyle(e){return getComputedStyle(this.HTMLElement,e)}click(){this.HTMLElement.click()}focus(){this.HTMLElement.focus()}remove(){this.HTMLElement.remove()}addChild(e){e instanceof HTMLElement&&(e=new n(e)),this.HTMLElement.appendChild(e.HTMLElement)}select(e){if(!this.HTMLElement.querySelector(e))throw`Invaild HTMLElement by query : ${e}`}selectAll(t){let n=this.HTMLElement.querySelectorAll(t);return new e(this,n)}on(e,t){this.HTMLElement.addEventListener(e,t)}off(e,t){this.HTMLElement.removeEventListener(e,t)}}class s{constructor(e){e instanceof HTMLElement&&(e=new n(e)),this.element=e,this.modules=[],this.data={}}use(e){let t=new e(this).init(this);return this.modules.push(t),t}render(e){this.element.HTML=e}}function r(e,t,s,r){if(!r&&e.usePlaceholderElement)return e.placeholderElement;if(r)return new n(r);throw`Cannot find element by ${t} :'${s}' ! `}const i=new n(document.createElement("div"));class o{constructor(e=document,t=i){this.root=e,this.usePlaceholderElement=!1,this.placeholderElement=t}byId(e){return r(this,"id",e,document.getElementById(e))}byClassName(e,t=0){return r(this,"Class Name",e,document.getElementsByClassName(e)[t])}byTag(e,t=0){let n=document.getElementsByTagName(e)[t];return r(this,"Tag Name",className,n)}byName(e,t=0){return r(this,"Name",e,document.getElementsByName(e)[t])}byQuery(e,t=0){return r(this,"Query",e,document.querySelectorAll(e)[t])}}function h(e){return/{{(.*?)}}/g.test(e)}function l(e){let t=[],s={},r=[];for(let i=0;i<e.length;i++){let o=e[i];if(o.nodeType==Node.TEXT_NODE)h(o.textContent)&&t.push({node:o,temp:o.textContent});else if(o.nodeType==Node.ELEMENT_NODE){Array.from(o.attributes).forEach((e=>"t-ref"==e.localName?(s[e.value]=new n(o),void o.removeAttribute("t-ref")):"t-event"==e.localName?(r.push({node:o,key:e.value}),void o.removeAttribute("t-event")):void(h(e.localName)&&t.push({node:o,attr:e.localName,temp:e.value}))));let e=l(o.childNodes);t.push(...e.mem);let i=e.refs;s={...s,...i},r.push(...e.events)}}return{mem:t,refs:s,events:r}}function a(e,t){for(let n=0;n<e.length;n++){let s=e[n],r=s.temp,i=s.node,o=r.replace(/{{(.*?)}}/g,(e=>{let n=e.split(/{{|}}/)[1];try{return new Function(`return ${n}`).apply(t)}catch(e){if(window.TURTLE.TURTLE_DEV)throw document.body.innerHTML=`\n      \t\t\t\t<h5 style="color:red">Error when render content of  component  : "..  {{${n}}}.."</h5>\n      \t\t\t\t<pre style="color:red ; overflow-x:scroll; max-width:98%;">${e.stack}</pre>\n      \t\t\t`,"err";return"?"}}));s.atrr?i.setAttribute(s.atrr,o):i.textContent=o}}class d extends HTMLElement{constructor(){super(),this.componentID=t(),window.TURTLE.TURTLE_COMPONENTS[this.tagName]=window.TURTLE.TURTLE_COMPONENTS[this.tagName]??{},window.TURTLE.TURTLE_COMPONENTS[this.tagName][this.componentID]=this,this.props={},this.data={},this.refs={},this.states={},this.rerenderDepenedents=null,this.shouldRerender=!0,this.isRendered=!1,this.component_data={},this.usingShadowDOM=!1,this.template=document.createElement("template"),this.getAttribute("t-props")&&(this.props=window.TURTLE.TURTLE_PROPS[this.getAttribute("t-props")],delete window.TURTLE.TURTLE_PROPS[this.getAttribute("t-props")],this.removeAttribute("t-props"))}setState(e,t){this.states[e]=t,this.shouldRerender&&(null==this.rerenderDepenedents||this.rerenderDepenedents.includes(e))&&this.requestRender()}onCreate(){}onRemove(){}onFirstRender(){}onRerender(){}onRender(){}beforeRender(){}start(){}async requestRender(){if(this.isRendered)requestAnimationFrame((()=>{this.beforeRender(),a(this.mem,this),this.isRendered=!0,this.onRerender(),this.onRender()}));else{let e=l(this.template.content.childNodes);this.refs=e.refs,this.mem=e.mem,e.events.forEach((e=>{let t=window.TURTLE.TURTLE_EVENTS[e.key]??{};Object.keys(t).forEach((n=>{e.node.addEventListener(n,t[n])}))})),requestAnimationFrame((()=>{this.beforeRender(),a(this.mem,this),this.isRendered=!0,this.onFirstRender(),this.onRender()}));let t=this.usingShadowDOM?this.shadowRoot:this;t.textContent="",t.appendChild(this.template.content)}}async connectedCallback(){await this.start(),await this.onCreate(),await this.requestRender()}async disconnectedCallback(){await this.onRemove()}}function u(e,t){window.customElements.define(e,class extends d{async start(){this.template.innerHTML=await t.bind(this)(this)}})}function c(e){let n=t();return window.TURTLE.TURTLE_PROPS[n]=e,`t-props="${n}"`}function m(e){let n=t();return window.TURTLE.TURTLE_EVENTS[n]=e,`t-event="${n}"`}function T(e){return`t-ref="${e}"`}class E{constructor(e){this.app=e,this.data={},this.id=t(),this.modules=[]}use(e){let t=new e(this).init(this);return this.modules.push(t),t}}function w(e,t,n){e.events[t]||(e.events[t]=[]),e.events[t].forEach((e=>{e(n)}))}function p(e){let t=e.split("/");return t=t.filter((e=>""!=e)),t}function L(e,t=new URL("/",window.load)){let n=p(t.pathname),[s,r,i]=function(e={},t){let n=Object.keys(e);for(var s=0;s<n.length;s++){let e=0,i={},o=p(n[s]);if(o.length==t.length){for(var r=0;r<o.length;r++)if(":"==o[r][0])e++,i[o[r].substr(1,o[r].length)]=t[r];else if("*"==o[r]||o[r]==t[r]){e++;continue}if(e==o.length)return[!0,i,n[s]]}}return[!1,{}]}(e.routes,n),o={matched:i,params:r,query:t.searchParams,path:t.pathname};if(s){let t=Object.assign(e.routes[i]),n=t.component??null;if(e.info=o,t.protect){if(!t.protect({router:e,info:o}))return void w(e,"notallow",{router:e,info:o})}if(t.resolver){let s=t.resolver({router:e,info:o});if(s){if(s.redirect&&e.redirect(s.redirect),s.changeComponent&&(n=s.changeComponent),s.abort)return;s.block&&w(e,"notallow",{router:e,info:o})}}if(t.callback&&t.callback({router:e,info:o}),t.title&&(document.title=t.title),n){window.TURTLE.TURTLE_COMPONENTS[n.toUpperCase()]||t.loader&&t.loader({router:e,info:o});let s=document.createElement(n);s.router={},s.router={router:e,info:o},e.element.textContent="",e.element.appendChild(s)}}else w(e,"notfound",{router:e,info:o});w(e,"routeloaded",{router:e,info:o})}class f extends E{constructor(e){super(e)}init(e){return this.app.router=this,this}define(e){if(!e.element)throw"Invalid element !";this.element=document.querySelector(e.element),this.type=e.type||"hash",this.info={},this.routes=e.routes??{},this.events={onRouteMatched:[],onRouteChange:[]}}redirect(e,t=!1){if("hash"==this.type)if(t){window.history.replaceState(null,null,`#${e}`),e=window.location.hash.slice(1),L(this,new URL(e,window.location.origin))}else window.location.hash=e;else t?window.history.replaceState(null,null,`${e}`):window.history.pushState(null,null,`${e}`)}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}start(){let e=this;if("hash"==this.type){let t=window.location.hash.slice(1),n=new URL(t,window.location.origin);L(e,n)}"history"==this.type&&L(e,new URL("",window.location.href)),window.addEventListener("click",(function(t){let n=t.target;if(n.dataset.tlink){t.preventDefault();let s=n.dataset.tlink;e.redirect(s,!!n.dataset.treplace)}})),"hash"==this.type?window.addEventListener("hashchange",(function(t){let n=window.location.hash.slice(1),s=new URL(n,window.location.origin);L(e,s)})):window.addEventListener("popstate",(function(t){L(e,new URL("",window.location.href))}))}}class R{constructor(e){this.xhr=new XMLHttpRequest,this.URL=new URL(e.url),this.method=e.method,this.data=e.data,this.body=e.body,this.timeout=e.timeout,this.headers=e.headers??{},this.withCredentials=e.withCredentials??!1,this.responseType=e.responseType,this.sended=!1,this.events={abort:new Function,done:new Function,timeout:new Function,error:new Function},e.auth?this.auth={username:e.auth.username,password:e.auth.password}:this.auth=null}setHeader(e,t){this.headers[e]=t}getHeader(e){return this.headers[e]}deleteHeader(e){delete this.headers[e]}setParam(e,t){this.URL.searchParams.set(e,t)}deleteParam(e){this.URL.searchParams.delete(e)}getParam(e){this.URL.searchParams.get(e)}cancel(){if(!this.sended)throw"Cannot cancel request!";this.xhr.abort(),this.events.abort()}send(){return new Promise(((e,t)=>{null!=this.auth?this.xhr.open(this.method,this.URL.href,!0,this.auth.username,this.auth.password):this.xhr.open(this.method,this.URL.href,!0),this.xhr.timeout=this.timeout,this.headers&&Object.keys(this.headers).forEach((e=>{this.xhr.setRequestHeader(e,this.headers[e])})),this.xhr.responseType=this.responseType,this.xhr.withCredentials=this.withCredentials,this.data?(this.xhr.setRequestHeader("Content-Type","application/json;charset=UTF-8"),this.xhr.send(JSON.stringify(this.data))):this.xhr.send(this.body);let n=this;this.xhr.onerror=function(e){n.events.error(),t(e)},this.xhr.onabort=function(){n.events.abort(),e({abort:!0})},this.xhr.ontimeout=function(){n.events.timeout(),e({timeouted:!0})},this.xhr.onload=function(){if(4==n.xhr.readyState){console.log(n.xhr);let t=new g(n);n.events.done(t),e({response:t,timeouted:!1})}}}))}}class g{constructor(e){this.req=e,this.xhr=this.req.xhr,this.status=this.xhr.status,this.statusText=this.xhr.statusText,this.URL=this.xhr.responseURL,this.type=this.xhr.responseType}getHeader(e){return this.xhr.getResponseHeader(e)}getAllHeaders(){return this.xhr.getAllResponseHeaders()}text(){return this.xhr.responseText}json(){try{return JSON.parse(this.xhr.response)}catch(e){throw"Cannot parse JSON from response"}}raw(){return this.xhr.response}}class y extends E{constructor(e){super(e)}init(){return this.app.http=this,this}send(e){return new R(e).send()}}window.TURTLE_EVENTS={};class v{constructor(e,t){this.name=e,this.data=t}emit(){let e=window.TURTLE_EVENTS[this.name];if(e)for(var t in e)e[t].callback.bind(e[t].context)(this.data)}}class M extends E{constructor(e){super(e)}init(e){return this.app.event=this,this}emit(e,t){return new v(e,t)}on(e,t,n=this){window.TURTLE_EVENTS[e]||(window.TURTLE_EVENTS[e]=[]),window.TURTLE_EVENTS[e].push({callback:t,context:n})}off(e,t){window.TURTLE_EVENTS[e]||(window.TURTLE_EVENTS[e]=[]);let n=window.TURTLE_EVENTS[e];for(var s in n)n[s].callback===t&&window.TURTLE_EVENTS[e].splice(s,1)}deleteAllEventListener(e){window.TURTLE_EVENTS[e]=[]}}window.TURTLE={TURTLE_APPS:{},TURTLE_DEV:!0,TURTLE_COMPONENTS:{},TURTLE_EVENTS:{},TURTLE_PROPS:{},TURTLE_CONTEXT:{},TURTLE_STORES:{}};export{M as EventModule,y as HttpModule,f as RouterModule,s as TurtleApp,d as TurtleComponent,n as TurtleElement,v as TurtleEvent,e as TurtleListElement,R as TurtleRequest,g as TurtleResponse,o as TurtleSelector,u as component,m as events,c as props,T as ref};
